var crypto=require("crypto"),moment=require("moment"),User=require("../models/user"),Post=require("../models/post"),Comment=require("../models/comment"),logger=require("../common/log").logger;module.exports=function(e){function r(e,r,s){return e.session.user?void s():(e.flash("error","未登录"),r.redirect("/login"))}function s(e,r,s){return e.session.user?(e.flash("error","已登录"),r.redirect("back")):void s()}e.get("/",function(e,r){var s=e.query.p?parseInt(e.query.p):1;Post.getFive(null,s,function(t,o,n){t&&(o=[]),r.render("index",{title:"主页",user:e.session.user,posts:o,page:s,isFirstPage:s-1===0,isLastPage:5*(s-1)+o.length==n,success:e.flash("success").toString(),error:e.flash("error").toString()})})}),e.get("/login",s),e.get("/login",function(e,r){r.render("login",{title:"登录",user:e.session.user,success:e.flash("success").toString(),error:e.flash("error").toString()})}),e.post("/login",s),e.post("/login",function(e,r){var s=crypto.createHash("md5"),t=s.update(e.body.password).digest("hex");User.get(e.body.name,function(s,o){return s?(e.flash("error",s),r.redirect("/")):o?t!=o.password?(e.flash("error","密码错误"),r.redirect("/login")):(e.session.user=o,e.flash("success","登录成功"),void r.redirect("/")):(e.flash("error","用户名不存在"),r.redirect("/login"))})}),e.get("/reg",s),e.get("/reg",function(e,r){r.render("reg",{title:"登录",user:e.session.user,success:e.flash("success").toString(),error:e.flash("error").toString()})}),e.post("/reg",s),e.post("/reg",function(e,r){var s=e.body.name,t=e.body.password,o=e.body["password-repeat"],n=e.body.email;if(t!=o)return e.flash("error","密码不一致"),r.redirect("/reg");var a=crypto.createHash("md5");t=a.update(t).digest("hex");var i=new User({name:s,password:t,email:n});User.get(i.name,function(s,t){return s?(e.flash("error",s),r.redirect("/")):t?(e.flash("error","用户已存在"),r.redirect("/reg")):void i.save(function(s,t){return s?(e.flash("error",s),r.redirect("/reg")):(e.session.user=t,e.flash("success","注册成功"),void r.redirect("/"))})})}),e.get("/post",r),e.get("/post",function(e,r){logger.info("this is post"),r.render("post",{title:"登录",user:e.session.user,success:e.flash("success").toString(),error:e.flash("error").toString()})}),e.post("/post",r),e.post("/post",function(e,r){var s=e.session.user,t=[e.body.tag1,e.body.tag2,e.body.tag3],o=new Post(s.name,e.body.title,t,e.body.post);o.save(function(s){return s?(e.flash("error",s),r.redirect("/")):(e.flash("success","发布成功"),void r.redirect("/"))})}),e.get("/upload",r),e.get("/upload",function(e,r){r.render("upload",{title:"上传",user:e.session.user,success:e.flash("success").toString(),error:e.flash("error").toString()})}),e.post("/upload",r),e.post("/upload",function(e,r){e.flash("success","上传成功"),r.redirect("/upload")}),e.get("/logout",r),e.get("/logout",function(e,r){e.session.user=null,e.flash("success","登出成功"),r.redirect("/")}),e.get("/search",function(e,r){Post.search(e.query.keyword,function(s,t){return s?(e.flash("error",s),r.redirect("/")):void r.render("search",{title:"Search:"+e.query.keyword,user:e.session.user,posts:t,success:e.flash("success").toString(),error:e.flash("error").toString()})})}),e.get("/links",function(e,r){r.render("links",{title:"Links",user:e.session.user,success:e.flash("success").toString(),error:e.flash("error").toString()})}),e.get("/u/:name",r),e.get("/u/:name",function(e,r){var s=e.query.p?parseInt(e.query.p):1;User.get(e.params.name,function(t,o){return t?(e.flash("error",t),r.redirect("/")):o?void Post.getFive(o.name,s,function(t,n,a){return t?(e.flash("error",t),r.redirect("/")):void r.render("user",{title:o.name,user:e.session.user,posts:n,page:s,isFirstPage:s-1===0,isLastPage:5*(s-1)+n.length==a,success:e.flash("success").toString(),error:e.flash("error").toString()})}):(e.flash("error","用户名不存在"),r.redirect("/"))})}),e.get("/u/:name/:day/:title",r),e.get("/u/:name/:day/:title",function(e,r){Post.getOne(e.params.name,e.params.day,e.params.title,function(s,t){return s?(e.flash("error",s),r.redirect("/")):void r.render("article",{title:e.params.title,user:e.session.user,post:t,success:e.flash("success").toString(),error:e.flash("error").toString()})})}),e.post("/u/:name/:day/:title",r),e.post("/u/:name/:day/:title",function(e,r){var s=moment().format("YYYY-MM-DD HH-mm-ss"),t={name:e.body.name,title:e.body.title,time:s,website:e.body.website,content:e.body.content,head:e.session.user.head},o=new Comment(e.params.name,e.params.day,e.params.title,t);o.save(function(s){s&&(e.flash("error",s),r.redirect("back")),e.flash("success","评论成功"),r.redirect("back")})}),e.get("/edit/:name/:day/:title",r),e.get("/edit/:name/:day/:title",function(e,r){Post.edit(e.params.name,e.params.day,e.params.title,function(s,t){s&&(e.flash("error",s),r.redirect("back")),r.render("edit",{title:"edit",user:e.session.user,post:t,success:e.flash("success").toString(),error:e.flash("error").toString()})})}),e.post("/edit/:name/:day/:title",r),e.post("/edit/:name/:day/:title",function(e,r){Post.update(e.session.user.name,e.params.day,e.params.title,e.body.post,function(s){var t=encodeURI("/u/"+e.session.user.name+"/"+e.params.day+"/"+e.params.title);return s?(e.flash("error",s),r.redirect(t)):(e.flash("success","修改成功"),void r.redirect(t))})}),e.get("/remove/:name/:day/:title",r),e.get("/remove/:name/:day/:title",function(e,r){Post.remove(e.params.name,e.params.day,e.params.title,function(s){s&&(e.flash("error",s),r.redirect("back")),e.flash("success","删除成功"),r.redirect("/")})}),e.get("/archive",function(e,r){Post.getArchive(function(s,t){return s?(e.flash("error",s),r.redirect("back")):void r.render("archive",{title:"archive",posts:t,user:e.session.user,success:e.flash("success").toString(),error:e.flash("error").toString()})})}),e.get("/tags",function(e,r){Post.getTags(function(s,t){return s?(e.flash("error",s),r.redirect("/")):void r.render("tags",{title:"tags",user:e.session.user,tags:t,success:e.flash("success").toString(),error:e.flash("error").toString()})})}),e.get("/tags/:tag",function(e,r){Post.getTag(e.params.tag,function(s,t){return s?(e.flash("error",s),r.redirect("back")):void r.render("tag",{title:"Tag :"+e.params.tag,user:e.session.user,posts:t,success:e.flash("success").toString(),error:e.flash("error").toString()})})}),e.use(function(e,r){r.render("404")})};