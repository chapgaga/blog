function Comment(o,n,t,e){this.name=o,this.day=n,this.title=t,this.comment=e}function Post(o,n,t,e){this.name=o,this.title=n,this.post=e,this.tags=t}function User(o){this.name=o.name,this.password=o.password,this.email=o.email}var mongodb=require("./db");module.exports=Comment,Comment.prototype.save=function(o){var n=this.name,t=this.day,e=this.title,i=this.comment;mongodb.open(function(r,s){return r?o(r):void s.collection("posts",function(r,s){return r?(mongodb.close(),o(r)):void s.update({name:n,"time.day":t,title:e},{$push:{comments:i}},function(n){return mongodb.close(),n?o(n):void o(null)})})})};var settings=require("../settings"),Db=require("mongodb").Db,Connection=require("mongodb").Connection,Server=require("mongodb").Server;module.exports=new Db(settings.db,new Server(settings.host,settings.port),{safe:!0});var mongodb=require("./db"),moment=require("moment"),markdown=require("markdown").markdown;module.exports=Post,Post.prototype.save=function(o){var n={year:moment().format("YYYY"),month:moment().format("YYYY-MM"),day:moment().format("YYYY-MM-DD"),minute:moment().format("YYYY-MM-DD HH:mm:ss")},t={name:this.name,title:this.title,post:this.post,tags:this.tags,time:n,comments:[],pv:0};mongodb.open(function(n,e){return n?o(n):void e.collection("posts",function(n,e){return n?(mongodb.close(),o(n)):void e.save(t,{safe:!0},function(n){return mongodb.close(),n?o(n):void o(null)})})})},Post.getFive=function(o,n,t){mongodb.open(function(e,i){return e?t(e):void i.collection("posts",function(e,i){if(e)return mongodb.close(),t(e);var r={};o&&(r.name=o),i.count(r,function(o,e){i.find(r,{skip:5*(n-1),limit:5}).sort({time:-1}).toArray(function(o,n){return mongodb.close(),o?t(o):(n&&n.forEach(function(o){o.post=markdown.toHTML(o.post)}),void t(null,n,e))})})})})},Post.getOne=function(o,n,t,e){mongodb.open(function(i,r){return i?e(i):void r.collection("posts",function(i,r){return i?(mongodb.close(),e(i)):void r.findOne({name:o,"time.day":n,title:t},function(i,s){return i?(mongodb.close(),e(i)):void(s&&(r.update({name:o,"time.day":n,title:t},{$inc:{pv:1}},function(o){return mongodb.close(),o?e(o):void 0}),s.post=markdown.toHTML(s.post),s.comments.forEach(function(o){o.content=markdown.toHTML(o.content)}),e(null,s)))})})})},Post.edit=function(o,n,t,e){mongodb.open(function(i,r){return i?e(i):void r.collection("posts",function(i,r){return i?(mongodb.close(),e(i)):void r.findOne({name:o,"time.day":n,title:t},function(o,n){return mongodb.close(),o?e(o):void e(null,n)})})})},Post.update=function(o,n,t,e,i){mongodb.open(function(r,s){return r?i(r):void s.collection("posts",function(r,s){return r?(mongodb.close(),i(r)):void s.update({name:o,"time.day":n,title:t},{$set:{post:e}},function(o){return mongodb.close(),o?i(o):void i(null)})})})},Post.remove=function(o,n,t,e){mongodb.open(function(i,r){return i?e(i):void r.collection("posts",function(i,r){return i?(mongodb.close(),e(i)):void r.remove({name:o,"time.day":n,title:t},function(o){return mongodb.close(),o?e(o):void e(null)})})})},Post.getArchive=function(o){mongodb.open(function(n,t){return n?o(n):void t.collection("posts",function(n,t){return n?(mongodb.close(),o(n)):void t.find({},{name:1,time:1,title:1}).sort({time:-1}).toArray(function(n,t){return mongodb.close(),n?o(n):void o(null,t)})})})},Post.getTags=function(o){mongodb.open(function(n,t){return n?o(n):void t.collection("posts",function(n,t){return n?(mongodb.close(),o(n)):void t.distinct("tags",function(n,t){return mongodb.close(),n?o(n):void o(null,t)})})})},Post.getTag=function(o,n){mongodb.open(function(t,e){return t?n(t):void e.collection("posts",function(t,e){return t?(mongodb.close(),n(t)):void e.find({tags:o},{name:1,title:1,time:1}).sort({time:-1}).toArray(function(o,t){return mongodb.close(),o?n(o):void n(null,t)})})})},Post.search=function(o,n){mongodb.open(function(t,e){return t?n(t):void e.collection("posts",function(t,e){if(t)return mongodb.close(),n(t);var i=new RegExp(o,"i");e.find({title:i},{name:1,title:1,time:1}).sort({time:-1}).toArray(function(o,t){return mongodb.close(),o?n(o):void n(null,t)})})})};var mongodb=require("./db");module.exports=User,User.prototype.save=function(o){var n={name:this.name,password:this.password,email:this.email,head:Math.round(24*Math.random())};mongodb.open(function(t,e){return t?o(t):void e.collection("users",function(t,e){return t?(mongodb.close(),o(t)):void e.save(n,{safe:!0},function(n,t){return mongodb.close(),n?o(n):void o(null,t)})})})},User.get=function(o,n){mongodb.open(function(t,e){return t?n(t):void e.collection("users",function(t,e){return t?(mongodb.close(),n(t)):void e.findOne({name:o},function(o,t){return mongodb.close(),o?n(o):void n(null,t)})})})};